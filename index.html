<script type="module">
    import { db } from './firebase-config.js';
    import { ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { FolhaEngine } from './folha-engine.js';

    // CONFIGURA√á√ÉO DE ESTADO - FOCO PMDF 2025
    window.db = db;
    window.activeEx = localStorage.getItem('activeEx') || "CFO-2025";
    window.modoAtual = localStorage.getItem('modoAtual') || "TREINO CFO"; 
    window.pecaAtualNome = localStorage.getItem('pecaAtualNome') || "NOVO RELAT√ìRIO PM";

    window.historicoUndo = [];
    let debounceTimer = null;
    window.marcaTextoAtivo = false;
    window.currentColor = '#fef08a';

    // BIBLIOTECA INJETADA COM CONTE√öDO PMDF (EDITAL 03/2025)
    window.LISTA_PDF_BIBLIOTECA = [
        { nome: "EDITAL PMDF 03/2025 - ABERTURA", url: "edital_pmdf_2025.pdf" },
        { nome: "C√ìDIGO PENAL MILITAR (CPM)", url: "cpm_atualizado.pdf" },
        { nome: "C√ìDIGO PROC. PENAL MILITAR (CPPM)", url: "cppm_atualizado.pdf" },
        { nome: "ESTATUTO PMDF (LEI 7.289/84)", url: "estatuto_pmdf.pdf" },
        { nome: "MANUAL DE POL√çCIA JUDICI√ÅRIA MILITAR", url: "manual_pjm.pdf" },
        { nome: "TESES DE EXCLUS√ÉO - ART. 42 CPM", url: "teses_militar.pdf" }
    ];

    window.onload = async () => {
        FolhaEngine.montar('folha-total');
        atualizarDisplayModo(); 
        
        setTimeout(() => {
            const ed = document.getElementById('editor-principal');
            if(ed) {
                ed.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        const html = ed.innerHTML;
                        if(window.historicoUndo[window.historicoUndo.length -1] !== html) {
                            window.historicoUndo.push(html);
                            if(window.historicoUndo.length > 30) window.historicoUndo.shift();
                        }
                    }, 800);
                });
                ed.addEventListener('mouseup', () => {
                    if(window.marcaTextoAtivo) {
                        const selection = window.getSelection();
                        if (selection.toString().length > 0) document.execCommand('backColor', false, window.currentColor);
                    }
                });
            }
        }, 1000);
        await carregarRascunho();
        setInterval(salvarAutomatico, 30000);
    };

    window.renomearTreino = () => {
        const n = prompt("Defina o nome do Relat√≥rio/Quest√£o PMDF:", window.pecaAtualNome);
        if (n && n.trim() !== "") { 
            window.pecaAtualNome = n.trim(); 
            persistirERefrescar();
        }
    };

    // GAVETAS AJUSTADAS PARA CARREIRA POLICIAL (OFICIAL PM)
    window.gerenciadorPasta = () => {
        const modal = document.getElementById('universal-modal');
        const content = document.getElementById('modal-content');
        document.getElementById('modal-back-btn').style.display = "none";
        document.getElementById('modal-title').innerText = "üìÇ GAVETAS DE INTELIG√äNCIA PMDF";
        content.innerHTML = `
            <div class="opt-btn" onclick="window.abrirGavetaEspecifica('QUEST√ïES PM')"><span>QUEST√ïES DISCURSIVAS</span> <i class="fas fa-question-circle" style="color:var(--questoes)"></i></div>
            <div class="opt-btn" onclick="window.abrirGavetaEspecifica('TREINO CFO')"><span>TREINO DE PE√áAS (IPM)</span> <i class="fas fa-shield-alt" style="color:#facc15"></i></div>
            <div class="opt-btn" onclick="window.abrirGavetaEspecifica('TESES MILITARES')"><span>TESES (CPM/CPPM)</span> <i class="fas fa-gavel" style="color:var(--teses)"></i></div>
            <div class="opt-btn" onclick="window.abrirListaExamesGaveta()"><span>HIST√ìRICO CONCURSOS</span> <i class="fas fa-archive" style="color:var(--gold)"></i></div>
        `;
        modal.style.display = 'flex';
    };

    // MODELOS DE ESTRUTURA PARA PMDF (BOT√ÉO PERGAMINHO)
    window.abrirPergaminho = () => {
        const modal = document.getElementById('universal-modal');
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "üìú ESTRUTURAS DE POL√çCIA JUDICI√ÅRIA MILITAR";
        content.innerHTML = `
            <div class="opt-btn" onclick="window.injetarEstrutura('IPM')"><span>RELAT√ìRIO DE IPM (ART. 22 CPPM)</span> <i class="fas fa-file-alt"></i></div>
            <div class="opt-btn" onclick="window.injetarEstrutura('APFM')"><span>AUTO DE PRIS√ÉO EM FLAGRANTE (APFM)</span> <i class="fas fa-handcuffs"></i></div>
            <div class="opt-btn" onclick="window.injetarEstrutura('SINDICANCIA')"><span>SINDICANCIA ADMINISTRATIVA</span> <i class="fas fa-clipboard-list"></i></div>
        `;
        modal.style.display = 'flex';
    };

    window.injetarEstrutura = (tipo) => {
        const ed = document.getElementById('editor-principal');
        const modelos = {
            'IPM': '<b>AO SENHOR ENCARREGADO DO INQU√âRITO POLICIAL MILITAR N¬∫ ...</b><br><br><b>RELAT√ìRIO FINAL</b><br><br><b>ENCARREGADO:</b> Aluno-Oficial PM ..., Matr√≠cula ...<br><br><b>INDICIADO:</b> ..., Gradua√ß√£o/Posto..., RG Militar...<br><br>O presente Inqu√©rito Policial Militar foi instaurado por meio da Portaria n¬∫ ... com o fito de apurar a conduta tipificada no Art. ... do C√≥digo Penal Militar...',
            'APFM': '<b>AUTO DE PRIS√ÉO EM FLAGRANTE MILITAR (ART. 243 CPPM)</b><br><br>Aos ... dias do m√™s de ... de 2026, no Quartel do ... Batalh√£o da PMDF, perante mim, Aluno-Oficial PM..., compareceu o condutor...',
            'SINDICANCIA': '<b>RELAT√ìRIO DE SINDIC√ÇNCIA ADMINISTRATIVA DISCIPLINAR</b><br><br><b>OBJETO:</b> Apura√ß√£o de transgress√£o disciplinar prevista na Lei n¬∫ 7.289/84 e Decreto n¬∫ 4.345/02...<br><br><b>SINDICADO:</b> ...'
        };
        if(confirm("Deseja injetar esta estrutura oficial da PMDF? O texto atual ser√° substitu√≠do.")) {
            ed.innerHTML = modelos[tipo];
            document.getElementById('universal-modal').style.display = 'none';
        }
    };

    // PERSIST√äNCIA E DISPLAY - FOCO NO EDITAL CFO
    function persistirERefrescar() {
        localStorage.setItem('modoAtual', window.modoAtual);
        localStorage.setItem('pecaAtualNome', window.pecaAtualNome);
        localStorage.setItem('activeEx', window.activeEx);
        atualizarDisplayModo();
    }

    window.atualizarDisplayModo = () => {
        const display = document.getElementById('ex-display');
        const ident = document.getElementById('identificador-peca');
        display.innerText = "PMDF CFO 2025";
        ident.innerHTML = `${window.pecaAtualNome} <i class="fas fa-shield" style="font-size:10px; opacity:0.5; color:var(--gold)"></i>`;
    };

    // FINALIZAR COM REGRA DE DISQUETE [2026-01-30]
    window.finalizarPeca = async () => {
        const ed = document.getElementById('editor-principal');
        if(!ed) return;
        const tipo = window.modoAtual; 
        const nomeAlvo = window.pecaAtualNome;

        if (!confirm(`Deseja salvar e fechar "${nomeAlvo}" na gaveta [${tipo}] para o hist√≥rico PMDF?`)) return;

        try {
            const agora = new Date();
            const dataF = agora.toLocaleDateString('pt-BR') + " " + agora.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
            const idFinal = Date.now().toString();
            
            await set(ref(db, `producao_pmdf/HISTORICO/${idFinal}`), {
                exame: tipo, 
                peca: `${nomeAlvo} (CFO-2025)`, 
                conteudo: ed.innerHTML,
                data: dataF
            });
            alert("‚úÖ Miss√£o Cumprida! Guardado no hist√≥rico da Mentoria PM.");
            ed.innerHTML = ""; // Limpa ap√≥s salvar conforme instru√ß√£o
        } catch (e) { alert("Erro ao salvar no banco PMDF."); }
    };

    // Restante das fun√ß√µes de visualiza√ß√£o de PDF (window.verPDF, fecharPDF, etc) permanecem iguais para manter a estrutura Master OAB
</script>
