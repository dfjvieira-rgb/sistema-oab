<script type="module">
    // MANTENDO SUA INTEGRAÃ‡ÃƒO COM FIREBASE
    import { db } from './firebase-config.js';
    import { ref, get, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const PROJETO_ID = "SISTEMA_OPERACIONAL_JOAQUIM";
    window.pecaAtualNome = localStorage.getItem('estudo_nome') || "TREINO OPERACIONAL";

    // --- ACERVO DE PROVAS ANTERIORES (PMDF & PMGO) ---
    const BANCO_PROVAS = [
        { id: 'PMDF_2023', banca: 'AOCP', cargo: 'Soldado PMDF 2023', url: 'https://www.institutoaocp.org.br/concursos/arquivos/pmdf_soldado_prova_tipo_a.pdf' },
        { id: 'PMGO_2022', banca: 'GOAL', cargo: 'Soldado PMGO 2022', url: 'https://bit.ly/prova-pmgo-2022' }, // Link representativo do acervo
        { id: 'PMDF_DISC', banca: 'AOCP', cargo: 'Espelho Discursiva PMDF', url: 'https://www.institutoaocp.org.br/concursos/arquivos/pmdf_soldado_espelho_redacao.pdf' }
    ];

    window.onload = async () => {
        document.getElementById('label-exame').innerText = window.pecaAtualNome;
        await carregarRascunho();
        setInterval(salvarAutomatico, 30000);
    };

    // --- FUNÃ‡ÃƒO PARA CARREGAR A PROVA NO SEU PDF-PANEL ---
    window.abrirProvasFGV = () => {
        const modal = document.getElementById('universal-modal') || { style: {} };
        const content = document.getElementById('annotations-list'); // Usando seu container de lista
        
        let html = `<h4 style="color:var(--primary)">ðŸ“‹ PROVAS ANTERIORES</h4>`;
        BANCO_PROVAS.forEach(p => {
            html += `
                <div class="exame-btn" onclick="window.carregarProvaNoSistema('${p.url}', '${p.cargo}')">
                    <strong>${p.cargo}</strong><br>
                    <small>Banca: ${p.banca}</small>
                </div>`;
        });
        
        // Se estiver usando o painel de anotaÃ§Ãµes como modal temporÃ¡rio:
        openAnnotationsPanel('provas'); 
        document.getElementById('annotations-list').innerHTML = html;
    };

    window.carregarProvaNoSistema = (url, nome) => {
        document.getElementById('v-enu').src = url;
        window.pecaAtualNome = "PROVA: " + nome;
        document.getElementById('label-exame').innerText = window.pecaAtualNome;
        closeAnnotationsPanel(); // Volta para a visÃ£o de PDF
    };

    // --- PERSISTÃŠNCIA E BACKUP (CONFORME SEU PEDIDO) ---
    async function salvarAutomatico() {
        const conteudo = document.getElementById('area-peca').value;
        if(conteudo) {
            set(ref(db, `${PROJETO_ID}/RASCUNHO`), { 
                texto: conteudo, 
                meta: window.pecaAtualNome,
                timestamp: Date.now() 
            });
        }
    }

    async function carregarRascunho() {
        const snap = await get(ref(db, `${PROJETO_ID}/RASCUNHO`));
        if(snap.exists()) {
            document.getElementById('area-peca').value = snap.val().texto;
            window.pecaAtualNome = snap.val().meta;
        }
    }

    // --- FUNÃ‡Ã•ES DE INTERFACE ---
    window.fazerBackup = () => {
        const data = document.getElementById('area-peca').value;
        const blob = new Blob([data], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ESTUDO_${window.pecaAtualNome}.txt`;
        a.click();
    };

    // Mantendo suas funÃ§Ãµes de anotaÃ§Ãµes integradas
    window.openAnnotationsPanel = (type) => {
        document.getElementById('pdf-panel').style.display = 'none';
        document.getElementById('annotations-manager-panel').style.display = 'flex';
        renderAnnotations(type);
    };

    window.closeAnnotationsPanel = () => {
        document.getElementById('pdf-panel').style.display = 'flex';
        document.getElementById('annotations-manager-panel').style.display = 'none';
    };
</script>
