<script type="module">
    import { db } from './firebase-config.js';
    import { ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { FolhaEngine } from './folha-engine.js';

    // --- CONFIGURAÇÃO MASTER OAB / PM 2026 ---
    const PATH_HISTORICO = "ESTUDO_PM_JOAQUIM/HISTORICO_OFICIAL";
    const PATH_RASCUNHO = "ESTUDO_PM_JOAQUIM/MASTER_RASCUNHO";

    window.db = db;
    window.activeEx = localStorage.getItem('activeEx') || "39";
    window.modoAtual = localStorage.getItem('modoAtual') || "TREINO"; 
    window.pecaAtualNome = localStorage.getItem('pecaAtualNome') || "NOVO TREINO";

    window.historicoUndo = [];
    let debounceTimer = null;
    window.marcaTextoAtivo = false;
    window.currentColor = '#fef08a';

    // --- BIBLIOTECA DE APOIO ---
    window.LISTA_PDF_BIBLIOTECA = [
        { nome: "TABELA IDENTIFICAÇÃO DE PEÇAS", url: "identificacaopecas.pdf" },
        { nome: "RESUMINHO APOSTAS!", url: "RESUMINHO APOSTAS!.pdf" },
        { nome: "LINHA DO TEMPO - PEÇAS", url: "LINHA DO TEMPO.pdf" },
        { nome: "TESES OAB 2ª FASE", url: "TESES_OAB.pdf" },
        { nome: "100 ARTIGOS PARA GRIFAR", url: "100_ARTIGOS.PDF" }
    ];

    window.onload = async () => {
        // Inicializa a Folha com as 150 linhas mecânicas
        FolhaEngine.montar('folha-total');
        atualizarDisplayModo(); 
        
        setTimeout(() => {
            const ed = document.getElementById('editor-principal');
            if(ed) {
                ed.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        const html = ed.innerHTML;
                        if(window.historicoUndo[window.historicoUndo.length -1] !== html) {
                            window.historicoUndo.push(html);
                            if(window.historicoUndo.length > 30) window.historicoUndo.shift();
                        }
                    }, 800);
                });
                ed.addEventListener('mouseup', () => {
                    if(window.marcaTextoAtivo) {
                        const selection = window.getSelection();
                        if (selection.toString().length > 0) document.execCommand('backColor', false, window.currentColor);
                    }
                });
            }
        }, 1000);

        await carregarRascunho();
        setInterval(salvarAutomatico, 30000); // Backup automático a cada 30s
    };

    // --- INTELIGÊNCIA DOS EXAMES (35-39) ---
    window.injetarTeses = () => {
        const modal = document.getElementById('universal-modal');
        const content = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = "⚖️ MARTELO: TESES (35-39)";
        
        content.innerHTML = `
            <div class="opt-btn" onclick="FolhaEngine.injetarTextoMultilinhas('Súmula 369, I, TST: Estabilidade de dirigente sindical garantida mesmo com comunicação fora do prazo, se dentro do contrato.')"><span>Ex 35: Dirigente Sindical</span></div>
            <div class="opt-btn" onclick="FolhaEngine.injetarTextoMultilinhas('Art. 614, §3º CLT: Vedada a ultratividade de norma coletiva. Acabou o prazo, acabou o direito.')"><span>Ex 36: Ultratividade</span></div>
            <div class="opt-btn" onclick="FolhaEngine.injetarTextoMultilinhas('Art. 11-A CLT: Prescrição Intercorrente exige inércia por 2 anos (Exame 37 acusou erro em 1 ano).')"><span>Ex 37: Prescrição Execução</span></div>
            <div class="opt-btn" onclick="FolhaEngine.injetarTextoMultilinhas('Art. 486 CLT: Fato do Príncipe. Paralisação por ato de autoridade municipal/estadual.')"><span>Ex 38: Fato do Príncipe</span></div>
            <div class="opt-btn" onclick="FolhaEngine.injetarTextoMultilinhas('OJ 365 SDI-I: Membro de Conselho Fiscal não tem estabilidade (Exame 39).')"><span>Ex 39: Conselho Fiscal</span></div>
        `;
        modal.style.display = 'flex';
    };

    // --- GESTÃO DE GAVETAS (FIREBASE MASTER) ---
    window.finalizarPeca = async () => {
        const ed = document.getElementById('editor-principal');
        const tipo = window.modoAtual; 
        const nomeAlvo = window.pecaAtualNome;

        if(!confirm(`Deseja salvar "${nomeAlvo}" na Gaveta [${tipo}]?`)) return;

        try {
            const idFinal = Date.now().toString();
            const agora = new Date();
            const dataF = agora.toLocaleDateString('pt-BR') + " " + agora.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
            
            await set(ref(db, `${PATH_HISTORICO}/${idFinal}`), {
                exame: tipo, 
                peca: `${nomeAlvo} (${dataF})`, 
                conteudo: ed.innerHTML
            });
            alert("✅ Guardado no Plano de Voo!");
        } catch (e) { alert("Erro ao salvar no Firebase."); }
    };

    // --- FUNÇÕES DE NAVEGAÇÃO E PDF ---
    window.verPDF = (t) => {
        const f = document.getElementById('pdf-frame');
        let url = "";
        
        switch(t) {
            case 'P': url = `ro${window.activeEx}.pdf`; break;
            case 'G': url = `ro${window.activeEx}-gabarito.pdf`; break;
            case 'V': url = 'vade.pdf'; break;
            case 'LP': url = 'livro_processo.pdf'; break;
            case 'LM': url = 'livro_material.pdf'; break;
        }
        
        f.src = url;
        document.getElementById('pdf-title').innerText = `DOCUMENTO: ${url}`;
        document.getElementById('pdf-viewer').classList.add('active');
        window.toggleRecolherEditor(); 
    };

    window.abrirExames = () => {
        const modal = document.getElementById('universal-modal');
        document.getElementById('modal-title').innerText = "ESCOLHER EXAME (35-39)";
        const content = document.getElementById('modal-content');
        content.innerHTML = "";
        for(let i=39; i>=35; i--) {
            const b = document.createElement('div'); b.className = 'opt-btn'; 
            b.innerHTML = `<span>EXAME ${i} ${i==39?'(ÚLTIMO)':''}</span> <i class="fas fa-chevron-right"></i>`;
            b.onclick = () => { 
                window.activeEx = i.toString(); 
                window.modoAtual = i.toString(); 
                window.pecaAtualNome = "PEÇA OFICIAL"; 
                persistirERefrescar();
                modal.style.display = 'none';
            };
            content.appendChild(b);
        }
        modal.style.display = 'flex';
    };

    // --- UTILITÁRIOS ---
    window.desfazer = () => {
        if(window.historicoUndo.length > 1) {
            window.historicoUndo.pop();
            const estadoAnterior = window.historicoUndo[window.historicoUndo.length - 1];
            document.getElementById('editor-principal').innerHTML = estadoAnterior;
        }
    };

    window.renomearTreino = () => {
        const n = prompt("Nome do Documento:", window.pecaAtualNome);
        if (n) { window.pecaAtualNome = n; persistirERefrescar(); }
    };

    async function salvarAutomatico() { 
        const ed = document.getElementById('editor-principal'); 
        if(ed && ed.innerText.trim() !== "") {
            await set(ref(db, PATH_RASCUNHO), { conteudo: ed.innerHTML, timestamp: Date.now() }); 
        }
    }

    async function carregarRascunho() { 
        const snap = await get(ref(db, PATH_RASCUNHO)); 
        if(snap.exists()) document.getElementById('editor-principal').innerHTML = snap.val().conteudo; 
    }

    function persistirERefrescar() {
        localStorage.setItem('modoAtual', window.modoAtual);
        localStorage.setItem('pecaAtualNome', window.pecaAtualNome);
        localStorage.setItem('activeEx', window.activeEx);
        atualizarDisplayModo();
    }

    window.atualizarDisplayModo = () => {
        document.getElementById('ex-display').innerText = isNaN(window.modoAtual) ? window.modoAtual : "EXAME " + window.modoAtual;
        document.getElementById('identificador-peca').innerHTML = `${window.pecaAtualNome} <i class="fas fa-pen" style="font-size:10px; opacity:0.5"></i>`;
    };

    // Funções de interface (fechar, recolher) mantidas conforme Parte 1
    window.fecharPDF = () => {
        document.getElementById('pdf-viewer').classList.remove('active', 'full-view');
        document.getElementById('editor-container').classList.remove('collapsed');
    };
    window.toggleRecolherEditor = () => {
        document.getElementById('editor-container').classList.toggle('collapsed');
        document.getElementById('pdf-viewer').classList.toggle('full-view');
    };
    window.toggleFoguete = () => document.getElementById('mobile-hub').classList.toggle('active');

</script>
