<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MENTORIA ELITE PMDF - V13 FULL PAGE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #020617; --gold: #fbbf24; --card: #1e293b;
            --const: #ef4444; --adm: #f97316; --penal: #3b82f6; --proc: #06b6d4;
            --cpm: #8b5cf6; --cppm: #ec4899; --leg: #10b981; --lo: #facc15;
            --peca: #a855f7; --nc: #f472b6; --bg-paper: #cbd5e1;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--primary); color: white; margin: 0; overflow: hidden; height: 100vh; }

        header {
            background: var(--card); padding: 10px 20px; border-bottom: 3px solid var(--gold);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }

        main { display: flex; height: calc(100vh - 63px); }

        /* SIDEBAR COMPLETA */
        .sidebar { 
            width: 70px; background: #1e293b; display: flex; flex-direction: column; 
            align-items: center; gap: 12px; padding: 15px 0; border-right: 1px solid rgba(255,255,255,0.1); 
        }
        .btn-side { 
            width: 50px; height: 50px; border: none; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; color: white; 
            cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.05);
        }
        .btn-side:hover { background: rgba(255,255,255,0.15); transform: scale(1.05); }
        .btn-side i { font-size: 1.2rem; color: var(--gold); }

        /* EDITOR E PAPEL */
        .editor-container { flex: 1; background: var(--bg-paper); overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .toolbar-top {
            width: 100%; max-width: 850px; background: white; padding: 10px; 
            display: flex; gap: 10px; border-radius: 8px 8px 0 0; border-bottom: 1px solid #eee;
            flex-wrap: wrap; justify-content: center;
        }
        .btn-tool { padding: 8px 12px; border: none; background: #f1f5f9; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; color: #475569; }

        .paper { 
            width: 100%; max-width: 850px; background: white; min-height: 1200px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding: 60px; color: #000;
        }
        #folha-total { outline: none; line-height: 1.8; font-size: 16px; font-family: 'Times New Roman', serif; text-align: justify; }

        /* HUB FULL PAGE */
        #hub-inteligencia {
            position: fixed; inset: 0; background: var(--primary); z-index: 9999;
            display: none; flex-direction: column; animation: fadeIn 0.2s ease-in-out;
        }
        #hub-inteligencia.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header-hub {
            background: var(--card); padding: 15px 20px; border-bottom: 3px solid var(--gold);
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-voltar { background: white; color: black; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 900; cursor: pointer; }

        .conteudo-hub { flex: 1; overflow-y: auto; padding: 20px; max-width: 900px; margin: 0 auto; width: 100%; }

        .panel-input { background: #0f172a; border-radius: 15px; padding: 20px; margin-bottom: 25px; border: 1px dashed #334155; }
        input, textarea { width: 100%; padding: 12px; margin: 5px 0; background: #1e293b; border: 1px solid #475569; color: white; border-radius: 8px; }

        .post-it { padding: 20px; border-radius: 18px; margin-bottom: 20px; color: #020617; }
        .post-it strong { display: block; font-size: 1.1rem; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 8px; margin-bottom: 10px; }
        
        .nav-tabs { background: var(--card); display: flex; overflow-x: auto; padding: 15px; gap: 10px; border-top: 2px solid var(--gold); }
        .tab { min-width: 100px; padding: 12px; background: #0f172a; border-radius: 10px; color: #94a3b8; text-align: center; font-size: 10px; font-weight: 800; cursor: pointer; flex-shrink: 0; }
        .tab.active { background: var(--gold); color: black; }

        .color-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; }
    </style>
</head>
<body>

<header>
    <div class="logo" style="font-weight:900;">JOAQUIM <span style="color:var(--gold)">ELITE PMDF</span></div>
    <div style="font-size: 11px; color: var(--gold); font-weight: 800;">MISSÃO: ALUNO-OFICIAL CFO</div>
</header>

<main>
    <aside class="sidebar">
        <button class="btn-side" style="background:var(--nc);" onclick="abrirHub('nc')" title="IA Não Confunda"><i class="fas fa-brain"></i></button>
        <button class="btn-side" style="background:var(--peca);" onclick="abrirHub('peca')" title="Pergaminho (Estruturas)"><i class="fas fa-scroll"></i></button>
        <button class="btn-side" style="background:var(--cpm);" onclick="abrirHub('cpm')" title="Leis Secas"><i class="fas fa-gavel"></i></button>
        <button class="btn-side" style="background:var(--leg);" onclick="salvarPeca()" title="Disquete (Salvar PDF)"><i class="fas fa-save"></i></button>
        <hr style="width:60%; opacity:0.1">
        <button class="btn-side" onclick="desfazer()"><i class="fas fa-undo"></i></button>
        <button class="btn-side" onclick="limparFolha()"><i class="fas fa-eraser"></i></button>
    </aside>

    <section class="editor-container">
        <div class="toolbar-top">
            <button class="btn-tool" onclick="document.execCommand('bold')"><b>B</b></button>
            <div style="display:flex; align-items:center; gap:5px; margin-left:10px;">
                <div class="color-dot" style="background:#fef08a;" onclick="ativarMarcaTexto('#fef08a')"></div>
                <div class="color-dot" style="background:#bbf7d0;" onclick="ativarMarcaTexto('#bbf7d0')"></div>
                <button class="btn-tool" onclick="ativarMarcaTexto('transparent')"><i class="fas fa-slash"></i></button>
            </div>
            <button class="btn-tool" style="margin-left:auto; background:var(--gold); color:black;" onclick="finalizarMissao()">FINALIZAR MISSÃO</button>
        </div>
        <div class="paper">
            <div id="folha-total" contenteditable="true" spellcheck="false">
                <b>AO JUÍZO DA VARA DE AUDITORIA MILITAR DO DISTRITO FEDERAL</b><br><br>
                Inquérito Policial Militar nº ...<br>
                Objeto: ...
            </div>
        </div>
    </section>
</main>

<div id="hub-inteligencia">
    <div class="header-hub">
        <button class="btn-voltar" onclick="fecharHub()"><i class="fas fa-arrow-left"></i> VOLTAR AO ESTUDO</button>
        <span id="titulo-hub" style="font-weight: 900; color: var(--gold); text-transform: uppercase;">INTELIGÊNCIA OPERACIONAL</span>
    </div>

    <div class="conteudo-hub">
        <div class="panel-input" id="panel-editor-hub">
            <input id="inp-t" placeholder="Título do Assunto (Ex: Art. 9 CPM)">
            <textarea id="inp-c" rows="3" placeholder="Conteúdo técnico para injetar na peça..."></textarea>
            <input id="inp-r" placeholder="Macete/Mnemônico (Opcional)">
            <button onclick="salvarHub()" style="width:100%; padding:15px; background:var(--gold); border:none; border-radius:10px; font-weight:900; cursor:pointer; color:black;">GRAVAR NA MEMÓRIA</button>
        </div>
        <div id="feed-hub"></div>
    </div>

    <nav class="nav-tabs">
        <div class="tab active" onclick="showTab('nc')">NÃO CONFUNDA</div>
        <div class="tab" onclick="showTab('peca')">ESTRUTURAS</div>
        <div class="tab" onclick="showTab('cpm')">PENAL MILITAR</div>
        <div class="tab" onclick="showTab('cppm')">PROC. PENAL MIL.</div>
        <div class="tab" onclick="showTab('leg')">LEGISLAÇÃO PM</div>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    // --- CONFIGURAÇÃO E ESTADO ---
    const config = {
        apiKey: "AIzaSyAmigODFK8R9c0-fWtagdxLWu9xkODfKYQ",
        authDomain: "masteroab-db5e1.firebaseapp.com",
        projectId: "masteroab-db5e1",
        databaseURL: "https://masteroab-db5e1-default-rtdb.firebaseio.com"
    };
    const app = initializeApp(config);
    const db = getDatabase(app);

    const QUALIFICACAO_CONSTANTES = {
        INDICIADO: "NOME DO INDICIADO, Posto/Graduação, RG nº ..., CPF nº ..., residente em...",
        VITIMA: "NOME DA VÍTIMA, qualificação completa conforme Art. ... do CPPM",
        AUTORIDADE: "AO SENHOR ENCARREGADO DO IPM / COMANDANTE DO ..."
    };

    let currentTab = 'nc';
    let cache = {};
    let historicoUndo = [];

    const temasMap = {
        nc: { t: 'Não Confunda', c: 'var(--nc)' },
        peca: { t: 'Estruturas de Peças', c: 'var(--peca)' },
        cpm: { t: 'Direito Penal Militar', c: 'var(--cpm)' },
        cppm: { t: 'Processo Penal Militar', c: 'var(--cppm)' },
        leg: { t: 'Legislação PMDF', c: 'var(--leg)' }
    };

    // --- LÓGICA DO EDITOR ---
    const ed = document.getElementById('folha-total');
    
    ed.addEventListener('input', () => {
        if(historicoUndo[historicoUndo.length - 1] !== ed.innerHTML) {
            historicoUndo.push(ed.innerHTML);
            if(historicoUndo.length > 30) historicoUndo.shift();
        }
    });

    window.desfazer = () => {
        if(historicoUndo.length > 1) {
            historicoUndo.pop();
            ed.innerHTML = historicoUndo[historicoUndo.length - 1];
        }
    };

    window.ativarMarcaTexto = (cor) => {
        document.execCommand('backColor', false, cor);
    };

    window.limparFolha = () => {
        if(confirm("Deseja apagar toda a folha de resposta?")) ed.innerHTML = "";
    };

    // --- LÓGICA DO HUB ---
    window.abrirHub = (tab) => {
        showTab(tab);
        document.getElementById('hub-inteligencia').classList.add('active');
    };

    window.fecharHub = () => {
        document.getElementById('hub-inteligencia').classList.remove('active');
    };

    window.showTab = (tab) => {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const activeTab = document.querySelector(`.tab[onclick*='${tab}']`);
        if(activeTab) activeTab.classList.add('active');
        document.getElementById('titulo-hub').innerText = temasMap[tab].t;
        render();
    };

    window.salvarHub = () => {
        const t = document.getElementById('inp-t').value;
        const c = document.getElementById('inp-c').value;
        const r = document.getElementById('inp-r').value;
        if(!t || !c) return alert("Preencha título e conteúdo!");
        push(ref(db, 'v13_master'), { t, c, r: r || "", cat: currentTab, ts: serverTimestamp() });
        document.getElementById('inp-t').value = ""; document.getElementById('inp-c').value = ""; document.getElementById('inp-r').value = "";
    };

    onValue(ref(db, 'v13_master'), (snap) => {
        cache = snap.val() || {};
        render();
    });

    function render() {
        const feed = document.getElementById('feed-hub');
        feed.innerHTML = "";
        Object.keys(cache).reverse().forEach(id => {
            const it = cache[id];
            if(it.cat === currentTab) {
                feed.innerHTML += `
                    <div class="post-it" style="background:${temasMap[it.cat].c}">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <strong>${it.t}</strong>
                            <i class="fas fa-trash" onclick="apagar('${id}')" style="cursor:pointer; opacity:0.4; font-size:12px"></i>
                        </div>
                        <p style="font-size:14px; margin:10px 0;">${it.c}</p>
                        ${it.r ? `<div class="macete-box">⚡ MACETE: ${it.r}</div>` : ""}
                        <button onclick="injetar('${id}')" style="margin-top:12px; width:100%; border:none; padding:12px; border-radius:8px; background:rgba(0,0,0,0.8); color:white; font-weight:bold; cursor:pointer;">INJETAR NA PEÇA</button>
                    </div>`;
            }
        });
    }

    window.injetar = (id) => {
        const it = cache[id];
        ed.focus();
        document.execCommand('insertHTML', false, `<br><br><b>${it.t}:</b><br>${it.c}<br>`);
        fecharHub();
    };

    window.apagar = (id) => { if(confirm("Apagar registro permanentemente?")) remove(ref(db, `v13_master/${id}`)); };

    // --- FINALIZAÇÃO E PDF ---
    window.salvarPeca = () => {
        window.print();
        alert("O PDF foi gerado. Conforme regra [2026-01-30], limpe o que o disquete salva e organize o conceito.");
    };

    window.finalizarMissao = () => {
        if(confirm("Deseja finalizar a peça e salvar no histórico definitivo?")) {
            alert("Missão Cumprida! Peça blindada.");
        }
    };
</
